# 【学习笔记】一套开源流水线平台方案 | 平台篇07

> 以主流开源解决方案为主，商业工具为辅，涵盖了 Jira、GitLab、Jenkins、SonarQube 和 Kubernetes 等，希望可以手把手地帮助你快速搭建一套完整的持续交付平台。

本篇专栏，作者通过一个开源流水线的解决方案，介绍了如何建立一个开源工具为主的持续交付流水线平台。

对于 DevOps 来说，真正的难点不在于工具本身，而在于如何基于整个研发流程将工具串联打通，把它们结合在一起，发挥出最大的优势。

## 需求管理 - Jira

需求作为一切开发工作的起点，是贯穿整个研发工作的重要抓手。对于 Jira 来说，**重点是要实现跟版本控制系统和开发者工具的打通**。

如果你也在使用特性分支开发模式，你应该知道，一个特性就对应到一个 Jira 中的任务。通过任务来创建特性分支，并且将所有分支上的提交绑定到具体任务上，从而建立清晰的特性代码关联。

推荐的方式是使用 Jira 和 GitLab 的 Webhook 进行打通。实现如下功能

1. GitLab 每次代码变更状态都会同步到 Jira 任务中，并且实现了 Jira 任务和代码的自动关联（Issue links）；
2. 可以在 MR 中增加关键字 Fixes/Resolves/Closes Jira 任务号，实现 Jira 的自动状态流转；
3. 每次在 Jira 中创建任务时，都会自动创建特性分支。

## 代码管理 - GitLab

版本控制系统和持续集成系统也需要双向打通。

代码提交触发持续集成：通过后台调用 GitLab 的 API 完成 Webhook 的自动注册，从而实现对代码变更事件的监听和任务的自动化执行。

持续集成更新代码状态：初衷是希望开发者在第一时间修复持续集成的问题。

1. 每次 GitLab 上的代码提交都可以通过 Webhook 触发对应的 Jenkins 任务。具体触发哪个任务，取决于你将哪个 Jenkins 任务的地址添加到了 GitLab 的 Webhook 配置中；
2. 每次 Jenkins 任务执行完毕后，会将执行结果写到 GitLab 的提交记录中。你可以查看执行状态，决定是否接受合并请求。

## 代码质量 - SonarQube

代码质量检查这类频繁执行的例行工作，也比较适合自动化完成，最佳途径就是集成到流水线中，也就是需要跟 Jenkins 进行打通。

对于 SonarQube 和 Jenkins 的集成，只需要单向进行即可。这也就是说，只要保证 Jenkins 的 Scanner 工具采集到的数据可以正确地上报到 SonarQube 平台端即可。

## 环境管理 - Kubernetes

想要实现动态初始化环境，需要打通 Jenkins 和 Kubernetes。

作为云原生时代的操作系统，Kubernetes 已经成为了云时代容器编排的事实标准。

一方面，可以实现环境的标准化。所有环境配置都是以代码的形式写在 Dockerfile 中的，实现了环境的统一可控。另一方面，环境的资源利用率大大提升，不再依托于宿主机自身的环境配置和资源大小，你只需要告诉 Kubernetes 需要多少资源，它就会帮助你找到合适的物理节点运行容器。

结合 Jenkins 自身的人工审批环节，可以实现多环境的自动和手动部署，构建一个真正的端到端持续交付流水线。

用开源还是商业软件是一个经典问题，需要看企业的文化土壤。

## Reference

- [DevOps实战笔记](https://time.geekbang.org/column/intro/235?code=GC0JpoFVv4WPkRF1zJR2ApOvhfke36rvSRJoaCEOd50%3D&utm_term=SPoster)