# 【学习笔记】环境管理，说说头号背锅侠 | 落地篇12

> 环境往往软件行业的“头号背锅侠”。
>
> 比如，线上出故障了，可以是环境配置错误；测试有些功能没测到，可以是没有测试环境；开发出 Bug 了，也不管三七二十一，先甩给环境再说……

本篇专栏依赖于 K8S/容器等经验，没有相关运维配置经验，相关内容可能有点难理解。

## 环境管理的挑战

关键词：多、杂、异、慢、追

- 多：光名称就有很多，开发环境、PL1-4环境、VT环境、灰度环境、生产环境；在上面要完成各种测试，单元测试、集成测试、用户测试。光分清楚环境与作用，就挺不容易。
- 杂：现代应用架构向微服务转变，环境配置/部署难度增加。
- 异：经典的甩锅名言“在我的机器上没问题”。难以保证各种环境配置的一致性。
- 慢：由于职责分离，环境的申请流程一般都比较冗长。
- 追：环境变更可追溯，环境配置变更的重要性，与代码变更一样，都需要严格管控。

## 基础设施即代码

> **基础设施即代码就是用一种描述性的语言，通过文本管理环境配置，并且自动化完成环境配置的方式**。
>
> 典型的就是以 CAPS 为代表的自动化环境配置管理工具，也就是 Chef、Ansible、Puppet 和 Saltstacks 四个开源工具的首字母缩写。

实际上，它的核心在于**通过代码化的方式来描述应用部署的环境和部署过程。**

每一个环境对应一个环境配置仓库，这个仓库中包含了应用部署所需要的一切过程。比如，使用 Kubernetes 的时候，就是应用的一组资源描述文件，比如部署哪个版本，开放哪些端口，部署过程是怎样的

## 方案过程描述

1. 代码变更：开发人员提交代码改动到 Git 仓库，触发持续集成流水线，生成一个新版本的应用；
2. 环境仓库代码合并：自动针对测试环境的配置仓库创建一个代码合并请求，自动化地触发部署流水线，将新版本的应用部署到测试环境中。
3. 逐级部署：类似于第2步，在一个环境中测试通过后，自动流转到下一个更接近用户的环境。直到生产环境。

在一个生产系统中，兄弟曾引入过容器管理，当时采用的是双栈并行的方式，即同时有虚拟化及容器部署两种方式。作者提出的一套维护双栈环境的方法，挺有启发

- 虚拟化可以采用传统的 Ansible 方式完成环境部署；

- 容器化使用镜像的 Dockerfile

- 结合两者优势起来，使用单一数据源维护标准环境。具体来说，在 Dockerfile 中，除了基础环境和启动脚本，环境配置部分同样采用 Ansible 的方式完成。

  举个例子

```dockerfile
FROM  harbor.devops.com:5000/test:ansible 
MAINTAINER XX <xx@devops.com>
ADD ./docker  /docker
WORKDIR /docker
RUN export TMPDIR=/var/tmp && ansible-playbook -v -i playbooks/inventories/docker playbooks/docker_container.yml
```



> 无论采用什么技术，代码化管理的方式都是未来的发展趋势

## Reference

- [DevOps实战笔记](https://time.geekbang.org/column/intro/235?code=GC0JpoFVv4WPkRF1zJR2ApOvhfke36rvSRJoaCEOd50%3D&utm_term=SPoster)