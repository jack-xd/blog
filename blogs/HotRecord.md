# 硬核：谈谈热点账户更新

> 支撑双十一、618背后的技术了解一下

## 问题背景

根据央行的发布的2019年支付支付体系运行总体情况报告，移动支付业务仍以较快速度发展。2019年，银行共处理电子支付业务2233.88亿笔，金额2607.04万亿元；非银行支付机构发生网络支付业务7199.98亿笔，金额249.88万亿元。

一年365天，掰掰手指头算算，每天至少数十亿笔支付交易，厉害了我的国。

## 问题定义

假设商户有4笔交易，如果这4笔交易是同时产生的，那么程序中的4个线程就会插入多条记录，然后更新余额。可以看到，4个线程插入的是不同明细，但是更新的是同一个余额。所以，4个线程需要竞争对余额的操作权。如果并发的交易数量非常大，这个账户所在的数据库行就称为热点行，也就产生了所谓的热点账户更新问题。

## 三户模型

**客户**

客户是一个较为社会化的概念，可以对应于商户入驻/商户签约，一般分为企业客户和个人小微客户，对应的主键可能会采用统一社会信用代码或者个人身份证。

**用户**

用户可以理解为登录系统的相关信息。譬如我们登录个人银行/企业银行会有不同的用户与密码。

**账户**

账户是为支持客户开展交易活动而开立的虚拟账户，主要与交易记账相关。热点账户更新问题里面的账户，指的就是这个。

## 账户的分类

按照资金发生的方向，可以把账户分为三类

1. 加频账户：入金比较频繁的账户。譬如红十字会筹款，开立的账户用于社会资金的汇入，这就是典型加频账户。
2. 减频账户：与加频账户相对应，出金比较频繁的账户。譬如企业给员工发工资的账户，又或者收支两条线中，特地设立用于退款等反向交易等账户。
3. 双频账户：即同时为加频与减频。例如三方支付机构的备付金账户。

## 暴力方案：限流

要想减少线程对账户的并发竞争，最直接的方案是：限流。该方案的思想是“**超出我能力范围的我不处理**”。

可以看到，该方案直接拒绝服务能力外的请求，暴力而有效。同时应该看到，这个方案对服务的请求方是不友好的。实践中，一般是对系统进行非功能测试后，获得系统的最大处理能力，再适当配置阈值，采用限流作为一种最终兜底方案。

## 乾坤大挪移：缓冲

系统交易洪峰往往是与业务营销时间节点挂勾的，譬如在双十一，商家设置了折扣率较大的引流商品，商品库存有限，往往会吸引大量用户在0点抢购。过了特定营销时间节点，系统交易量就会有明显的下降。

缓冲的方案很像乾坤大挪移，引入消息队列，先将请求接下来，将结果返回调用方，再将请求从消息队列中取出来依次处理。用一种空间换时间的方式，将同步转为异步，达到对交易洪峰削峰填谷的目的。

消息队列是一种较为常见的架构组件，市面上也有很多优秀的开源方案。采用缓冲方案，消息队列成为系统架构中的“咽喉之地”，团队需要有稳定运维消息队列集群的能力。

## 先登记，后算账：批量汇总清分

对于加频账户或者可透支账户来说，其实没必要每发生一笔交易就更新一次账户余额。

实践中，系统可以拆分为联机与批量两个集群，联机系统负责登记流水，对数据库来说没有热点行问题；批量系统负责清分流水，汇总记账，更新账户余额。兄弟曾经待过的一个系统，就是主要按照这个思路，支撑起日均数亿级别的商户收单交易。（当然，这个数量级的交易，在互联网巨头看来可能还只是零头）

采用这个方案需要注意在流水中登记清算批次，并管控批量集群，避免不同批次浪打浪。方案的问题还在于账户余额更新不及时，落后于当今账户实时更新的主流。

## 影分身：虚拟影子账户

热点账户，是由于多个线程都需要竞争同一个账户记录的操作权；如果不同线程可以操作不同的账户记录，就避免了竞争的出现。虚拟影子账户的方案就是基于这种思路而来的。

实践中，兄弟曾看过某系统将大商户按照一级机构的维度拆分成数十个虚拟子商户，交易会按照虚拟子商户进行路由汇总，最后再将各个子商户的余额汇总，更新真正的商户账户余额。

采用这个方案，需要注意考量影子账户的资金，同时考虑是否允许影子账户透支。



上面从问题背景、问题定义出发，接下来讨论三户模型、账户的分类，最后简单从思路上，介绍了常见的四种方案。从兄弟的经历来看，人的本性都是懒惰的，常常会抱着“应该不会有这么多人用吧”的思路，缺少对系统架构的深入思考，后果往往是上生产的一段“欲仙欲死”。不过，痛过了，也就成熟了。